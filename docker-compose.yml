version: "3.9"

services:
  api:
    build:
      context: .
      dockerfile: API/Dockerfile
    image: einstore-api:1.0.0
    environment:
      NODE_ENV: development
      PORT: 8100
      DATABASE_URL: postgresql://einstore:einstore@db:5432/einstore?schema=public
      AAPT_PATH: /usr/local/bin/aapt2
      AUTH_JWT_SECRET: change-me
      AUTH_JWT_ISSUER: einstore
      AUTH_JWT_AUDIENCE: einstore-api
      AUTH_REFRESH_TTL_DAYS: 30
      AUTH_ACCESS_TTL_MINUTES: 15
      API_KEY_SECRET: change-me
    ports:
      - "8100:8100"
    depends_on:
      - db

  admin:
    build:
      context: ./Admin
      dockerfile: Dockerfile
    image: einstore-admin:1.0.0
    environment:
      NODE_ENV: development
    ports:
      - "8101:8101"
    depends_on:
      - api

  caddy:
    image: caddy:2
    container_name: einstore-caddy
    depends_on:
      - api
      - admin
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/Caddyfile:/etc/caddy/Caddyfile
      - caddy-data:/data
      - caddy-config:/config

  db:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: einstore
      POSTGRES_PASSWORD: einstore
      POSTGRES_DB: einstore
    ports:
      - "8102:5432"
    volumes:
      - pgsql-data:/var/lib/postgresql/data

volumes:
  pgsql-data:
  caddy-data:
  caddy-config:
