generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlatformKind {
  ios
  watchos
  tvos
  visionos
  android
  wearos
  auto
}

enum TargetRole {
  app
  extension
  widget
  clip
  feature
}

enum VariantKind {
  abi
  density
  language
  device
}

enum ArtifactKind {
  privacy_manifest
  provisioning_profile
  entitlements
  permissions
  signing_info
  icon_set
  manifest
}

enum StorageKind {
  local
  s3
}

enum BuildEventKind {
  download
  install
}

enum UserStatus {
  active
  disabled
}

enum AuthProvider {
  google
  apple
}

enum TeamMemberRole {
  owner
  admin
  member
}

enum TeamVertical {
  regular
  hospitality
  retail
}

enum ExportPreset {
  global
  us
  gb
  ca
  au
  de
  fr
}

enum OverviewStatsPeriod {
  rolling_30_days
  calendar_month
}

model App {
  id        String   @id @default(uuid())
  teamId    String
  name      String
  identifier String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  versions  Version[]
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, identifier])
  @@index([teamId])
}

model Version {
  id        String   @id @default(uuid())
  appId     String
  version   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  app       App      @relation(fields: [appId], references: [id])
  builds    Build[]

  @@unique([appId, version])
}

model Build {
  id            String   @id @default(uuid())
  versionId     String
  buildNumber   String
  displayName   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  storageKind   StorageKind
  storagePath   String
  sizeBytes     Int
  createdByUserId String?

  version       Version  @relation(fields: [versionId], references: [id])
  targets       Target[]
  variants      Variant[]
  modules       Module[]
  artifacts     ComplianceArtifact[]
  signing       SigningIdentity?
  createdByUser User?    @relation("BuildCreatedBy", fields: [createdByUserId], references: [id])
  events        BuildEvent[]
  tags          BuildTag[]

  @@index([versionId])
  @@index([createdByUserId])
}

model Target {
  id             String      @id @default(uuid())
  buildId        String
  platform       PlatformKind
  role           TargetRole
  bundleId       String
  hostTargetId   String?
  minOsVersion   String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  build          Build       @relation(fields: [buildId], references: [id])
  hostTarget     Target?     @relation("TargetHost", fields: [hostTargetId], references: [id])
  hostedTargets  Target[]    @relation("TargetHost")
  capabilities   Capability[]

  @@index([buildId])
  @@index([bundleId])
}

model Variant {
  id         String      @id @default(uuid())
  buildId    String
  kind       VariantKind
  key        String
  value      String
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  build      Build       @relation(fields: [buildId], references: [id])

  @@index([buildId])
}

model Module {
  id         String   @id @default(uuid())
  buildId    String
  name       String
  onDemand   Boolean  @default(false)
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  build      Build    @relation(fields: [buildId], references: [id])

  @@unique([buildId, name])
}

model Capability {
  id         String   @id @default(uuid())
  targetId   String
  name       String
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  target     Target   @relation(fields: [targetId], references: [id])

  @@index([targetId])
}

model ComplianceArtifact {
  id         String       @id @default(uuid())
  buildId    String
  kind       ArtifactKind
  label      String?
  metadata   Json?
  storageKind StorageKind
  storagePath String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  build      Build        @relation(fields: [buildId], references: [id])

  @@index([buildId])
}

model SigningIdentity {
  id         String   @id @default(uuid())
  buildId    String   @unique
  issuer     String?
  subject    String?
  serial     String?
  metadata   Json?

  build      Build    @relation(fields: [buildId], references: [id])
}

model FeatureFlag {
  id             String                @id @default(uuid())
  key            String                @unique
  description    String?
  defaultEnabled Boolean               @default(false)
  metadata       Json?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  overrides      FeatureFlagOverride[]
}

model FeatureFlagOverride {
  id                String      @id @default(uuid())
  flagId            String
  scope             String      @default("platform")
  targetKey         String?
  enabled           Boolean     @default(false)
  rolloutPercentage Int?
  metadata          Json?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  flag              FeatureFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)

  @@index([flagId])
  @@index([scope, targetKey])
  @@unique([flagId, scope, targetKey])
}

model SiteSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id                  String               @id @default(uuid())
  username            String               @unique
  email               String?              @unique
  fullName            String?
  avatarUrl           String?
  status              UserStatus           @default(active)
  isSuperUser         Boolean              @default(false)
  lastActiveTeamId    String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  credential          Credential?
  sessions            Session[]
  oauthAccounts       OAuthAccount[]
  authCodes           AuthCode[]
  passwordResetTokens PasswordResetToken[]
  teamMemberships     TeamMember[]
  createdTeams        Team[]               @relation("TeamOwner")
  lastActiveTeam      Team?                @relation("LastActiveTeam", fields: [lastActiveTeamId], references: [id])
  userTeamSettings    UserTeamSetting[]
  createdBuilds       Build[]             @relation("BuildCreatedBy")
  buildEvents         BuildEvent[]
  createdApiKeys      ApiKey[]            @relation("ApiKeyCreator")
}

model ApiKey {
  id              String   @id @default(uuid())
  teamId          String
  name            String
  tokenHash       String   @unique
  tokenPrefix     String
  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastUsedAt      DateTime?
  revokedAt       DateTime?
  expiresAt       DateTime?

  team            Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdByUser   User?    @relation("ApiKeyCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([teamId])
  @@index([tokenPrefix])
  @@index([createdByUserId])
}

model Credential {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  passwordHash  String
  passwordAlgo  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastChangedAt DateTime @default(now())
}

model OAuthAccount {
  id             String       @id @default(uuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider       AuthProvider
  providerUserId String
  email          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([provider, providerUserId])
  @@index([userId])
}

model Session {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokenHash String   @unique
  createdAt        DateTime @default(now())
  expiresAt        DateTime
  ip               String?
  userAgent        String?
  revokedAt        DateTime?
  authCodes        AuthCode[]

  @@index([userId])
}

model AuthCode {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String?
  session   Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  codeHash  String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  usedAt    DateTime?
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  usedAt    DateTime?
}

model Team {
  id                        String              @id @default(uuid())
  name                      String
  slug                      String              @unique
  vertical                  TeamVertical        @default(regular)
  inboxBase                 String
  createdByUserId           String
  planName                  String              @default("free")
  planLimit                 Int                 @default(25)
  planPriceOverrideOne      Int?
  planPriceOverrideTeam     Int?
  stripeCustomerId          String?             @unique
  stripeSubscriptionId      String?             @unique
  subscriptionStatus        String?
  billingInterval           String?
  billingCurrency           String?             @default("GBP")
  seatBundleCount           Int                 @default(1)
  storageAddOnCount         Int                 @default(0)
  integrationAddOnCount     Int                 @default(0)
  prioritySupportAddOnCount Int                 @default(0)
  billingPeriodStart        DateTime?
  billingPeriodEnd          DateTime?
  billingCycleStartAt       DateTime            @default(now())
  defaultCurrency           String?             @default("GBP")
  country                   String?
  timezone                  String?
  vatRegistered             Boolean             @default(false)
  vatMissingThresholdMinor  Int?
  vatNumberRequired         Boolean             @default(false)
  categoryRequired          Boolean             @default(false)
  defaultExportPreset       ExportPreset        @default(global)
  storageLimitBytes         BigInt              @default(1073741824)
  overviewStatsPeriod       OverviewStatsPeriod @default(rolling_30_days)
  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt

  createdBy       User              @relation("TeamOwner", fields: [createdByUserId], references: [id])
  lastActiveUsers User[]            @relation("LastActiveTeam")
  members         TeamMember[]
  userTeamSettings UserTeamSetting[]
  apps            App[]
  buildEvents     BuildEvent[]
  apiKeys         ApiKey[]
  tags            Tag[]
}

model TeamMember {
  id        String         @id @default(uuid())
  teamId    String
  userId    String
  role      TeamMemberRole @default(member)
  createdAt DateTime       @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}

model UserTeamSetting {
  id        String   @id @default(uuid())
  userId    String
  teamId    String
  key       String
  value     Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId, key])
  @@index([teamId])
  @@index([userId])
}

model BuildEvent {
  id         String        @id @default(uuid())
  buildId    String
  teamId     String
  userId     String?
  kind       BuildEventKind
  platform   PlatformKind?
  targetId   String?
  deviceId   String?
  ip         String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime      @default(now())

  build      Build         @relation(fields: [buildId], references: [id], onDelete: Cascade)
  team       Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user       User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([buildId])
  @@index([teamId])
  @@index([userId])
  @@index([kind])
}

model Tag {
  id             String     @id @default(uuid())
  teamId         String
  name           String
  normalizedName String
  createdAt      DateTime   @default(now())

  team           Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  buildTags      BuildTag[]

  @@unique([teamId, normalizedName])
  @@index([teamId, normalizedName])
}

model BuildTag {
  buildId   String
  tagId     String
  createdAt DateTime @default(now())

  build Build @relation(fields: [buildId], references: [id], onDelete: Cascade)
  tag   Tag   @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([buildId, tagId])
  @@index([tagId])
  @@index([buildId])
}
